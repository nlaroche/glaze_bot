name: Deploy Supabase

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/**'
      - 'secrets/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SECRETS_REPO_SSH_KEY }}

      - name: Checkout submodules
        run: git submodule update --init --recursive

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "project_id=tspalglvgypdktuhgqtf" >> "$GITHUB_OUTPUT"
            echo "env_name=production" >> "$GITHUB_OUTPUT"
            echo "db_password=${{ secrets.SUPABASE_DB_PASSWORD_PROD }}" >> "$GITHUB_OUTPUT"
          else
            echo "project_id=zwpwjceczndedcoegerx" >> "$GITHUB_OUTPUT"
            echo "env_name=staging" >> "$GITHUB_OUTPUT"
            echo "db_password=${{ secrets.SUPABASE_DB_PASSWORD_STAGING }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Link Supabase project
        run: supabase link --project-ref ${{ steps.env.outputs.project_id }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ steps.env.outputs.db_password }}

      - name: Push database migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ steps.env.outputs.db_password }}

      - name: Deploy edge functions
        run: |
          for fn_dir in supabase/functions/*/; do
            fn_name=$(basename "$fn_dir")
            if [ "$fn_name" = "_shared" ]; then continue; fi
            echo "Deploying function: $fn_name"
            supabase functions deploy "$fn_name" --project-ref ${{ steps.env.outputs.project_id }}
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Install SOPS
        run: |
          curl -LO https://github.com/getsops/sops/releases/download/v3.9.4/sops-v3.9.4.linux.amd64
          chmod +x sops-v3.9.4.linux.amd64
          sudo mv sops-v3.9.4.linux.amd64 /usr/local/bin/sops

      - name: Sync secrets from SOPS to Supabase
        run: |
          set -euo pipefail

          PROJECT_REF="${{ steps.env.outputs.project_id }}"
          ENV_NAME="${{ steps.env.outputs.env_name }}"
          SECRETS_FILE="secrets/secrets.${ENV_NAME}.yaml"

          # Decrypt SOPS file
          sops --decrypt "$SECRETS_FILE" > /tmp/decrypted.yaml

          # Parse all key-value pairs from YAML (skip VITE_ prefixed â€” those are client-side only)
          declare -A sops_keys
          set_args=()
          while IFS=': ' read -r key value; do
            # Skip empty lines, comments, VITE_ keys
            [[ -z "$key" || "$key" == \#* || "$key" == VITE_* ]] && continue
            # Trim whitespace
            value="$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
            [[ -z "$value" ]] && continue
            sops_keys["$key"]=1
            set_args+=("${key}=${value}")
          done < /tmp/decrypted.yaml

          # Set all secrets from SOPS
          if [ ${#set_args[@]} -gt 0 ]; then
            echo "Setting ${#set_args[@]} secrets on project $PROJECT_REF"
            supabase secrets set "${set_args[@]}" --project-ref "$PROJECT_REF"
          fi

          # Get current secrets and remove any not in SOPS
          # (skip Supabase built-in secrets that start with SUPABASE_)
          existing=$(supabase secrets list --project-ref "$PROJECT_REF" 2>/dev/null | tail -n +3 | awk '{print $1}')
          unset_args=()
          for existing_key in $existing; do
            [[ "$existing_key" == SUPABASE_* ]] && continue
            if [[ -z "${sops_keys[$existing_key]+x}" ]]; then
              echo "Removing stale secret: $existing_key"
              unset_args+=("$existing_key")
            fi
          done

          if [ ${#unset_args[@]} -gt 0 ]; then
            supabase secrets unset "${unset_args[@]}" --project-ref "$PROJECT_REF"
          fi

          # Clean up
          rm -f /tmp/decrypted.yaml
          echo "Secrets sync complete."
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
