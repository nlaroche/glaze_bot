name: Deploy Supabase

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/**'
      - 'secrets'
      - 'secrets/**'
      - '.github/workflows/deploy-supabase.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SECRETS_REPO_SSH_KEY }}

      - name: Checkout submodules
        run: git submodule update --init --recursive

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install SOPS and setup age key
        run: |
          curl -LO https://github.com/getsops/sops/releases/download/v3.9.4/sops-v3.9.4.linux.amd64
          chmod +x sops-v3.9.4.linux.amd64
          sudo mv sops-v3.9.4.linux.amd64 /usr/local/bin/sops
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

      - name: Determine environment and decrypt secrets
        id: env
        run: |
          set -euo pipefail

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "project_id=tspalglvgypdktuhgqtf" >> "$GITHUB_OUTPUT"
            SECRETS_FILE="secrets/secrets.production.yaml"
          else
            echo "project_id=zwpwjceczndedcoegerx" >> "$GITHUB_OUTPUT"
            SECRETS_FILE="secrets/secrets.staging.yaml"
          fi

          # Decrypt SOPS
          sops --decrypt "$SECRETS_FILE" > /tmp/decrypted.yaml

          # Extract infrastructure values (grep -m1 || true to handle missing keys)
          DB_PASSWORD=$(grep -m1 'SUPABASE_DB_PASSWORD' /tmp/decrypted.yaml | sed 's/[^:]*: *//' || true)
          ACCESS_TOKEN=$(grep -m1 'SUPABASE_ACCESS_TOKEN' /tmp/decrypted.yaml | sed 's/[^:]*: *//' || true)

          echo "::add-mask::$DB_PASSWORD"
          echo "::add-mask::$ACCESS_TOKEN"
          echo "db_password=$DB_PASSWORD" >> "$GITHUB_OUTPUT"
          echo "access_token=$ACCESS_TOKEN" >> "$GITHUB_OUTPUT"

      - name: Link Supabase project
        run: supabase link --project-ref ${{ steps.env.outputs.project_id }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.env.outputs.access_token }}
          SUPABASE_DB_PASSWORD: ${{ steps.env.outputs.db_password }}

      - name: Push database migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.env.outputs.access_token }}
          SUPABASE_DB_PASSWORD: ${{ steps.env.outputs.db_password }}

      - name: Deploy edge functions
        run: |
          for fn_dir in supabase/functions/*/; do
            fn_name=$(basename "$fn_dir")
            if [ "$fn_name" = "_shared" ]; then continue; fi
            echo "Deploying function: $fn_name"
            supabase functions deploy "$fn_name" --project-ref ${{ steps.env.outputs.project_id }}
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.env.outputs.access_token }}

      - name: Sync secrets from SOPS to Supabase
        run: |
          set -euo pipefail

          PROJECT_REF="${{ steps.env.outputs.project_id }}"

          # Parse all key-value pairs from decrypted YAML
          # Skip comments, VITE_ (client-side), and infrastructure-only keys
          declare -A sops_keys
          set_args=()
          while IFS= read -r line; do
            # Skip comments and empty lines
            [[ -z "$line" || "$line" == \#* ]] && continue
            key="${line%%:*}"
            value="${line#*: }"
            # Skip VITE_ and infrastructure keys
            [[ "$key" == VITE_* || "$key" == SUPABASE_DB_PASSWORD || "$key" == SUPABASE_ACCESS_TOKEN ]] && continue
            # Trim whitespace
            value="$(echo "$value" | xargs)"
            [[ -z "$value" ]] && continue
            sops_keys["$key"]=1
            set_args+=("${key}=${value}")
          done < /tmp/decrypted.yaml

          # Set all secrets
          if [ ${#set_args[@]} -gt 0 ]; then
            echo "Setting ${#set_args[@]} secrets on project $PROJECT_REF"
            supabase secrets set "${set_args[@]}" --project-ref "$PROJECT_REF"
          fi

          # Remove stale secrets (skip Supabase built-ins and header lines)
          existing=$(supabase secrets list --project-ref "$PROJECT_REF" 2>/dev/null | awk '{print $1}' | grep -E '^[A-Za-z_][A-Za-z0-9_]*$' || true)
          unset_args=()
          for existing_key in $existing; do
            [[ -z "$existing_key" ]] && continue
            [[ "$existing_key" == SUPABASE_* || "$existing_key" == "NAME" ]] && continue
            if [[ -z "${sops_keys[$existing_key]+x}" ]]; then
              echo "Removing stale secret: $existing_key"
              unset_args+=("$existing_key")
            fi
          done

          if [ ${#unset_args[@]} -gt 0 ]; then
            supabase secrets unset "${unset_args[@]}" --project-ref "$PROJECT_REF"
          fi

          rm -f /tmp/decrypted.yaml
          echo "Secrets sync complete."
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.env.outputs.access_token }}
